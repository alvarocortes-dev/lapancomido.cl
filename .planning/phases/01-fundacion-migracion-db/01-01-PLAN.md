---
phase: 01-fundacion-migracion-db
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - turbo.json
  - apps/web/package.json
  - apps/web/vite.config.js
  - apps/admin/package.json
  - apps/admin/vite.config.js
  - apps/api/package.json
  - packages/database/package.json
  - packages/shared/package.json
  - .nvmrc
autonomous: true

must_haves:
  truths:
    - "npm run dev desde la raíz inicia todas las apps en paralelo"
    - "npm run build desde la raíz compila todas las apps en orden correcto"
    - "Cada app puede importar desde @lapancomido/shared y @lapancomido/database"
  artifacts:
    - path: "turbo.json"
      provides: "Configuración de tareas Turborepo"
      contains: "tasks"
    - path: "apps/web/package.json"
      provides: "App web pública"
      contains: "@lapancomido"
    - path: "apps/api/package.json"
      provides: "API Express"
      contains: "@lapancomido"
    - path: "packages/database/package.json"
      provides: "Paquete compartido de base de datos"
      contains: "@lapancomido/database"
    - path: "packages/shared/package.json"
      provides: "Paquete compartido de utilidades"
      contains: "@lapancomido/shared"
  key_links:
    - from: "apps/web/package.json"
      to: "@lapancomido/shared"
      via: "workspace dependency"
      pattern: "@lapancomido/shared.*workspace"
    - from: "apps/api/package.json"
      to: "@lapancomido/database"
      via: "workspace dependency"
      pattern: "@lapancomido/database.*workspace"
---

<objective>
Convertir el proyecto de estructura flat a monorepo Turborepo con estructura apps/ y packages/.

Purpose: Establecer la base de infraestructura para separar web público, admin y API en apps independientes con paquetes compartidos.
Output: Estructura Turborepo funcional con npm workspaces, turbo.json configurado, y todas las apps/packages inicializados.
</objective>

<execution_context>
@./.opencode/get-shit-done/workflows/execute-plan.md
@./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-fundacion-migracion-db/01-RESEARCH.md

# Código existente a migrar
@package.json
@vite.config.js
@api/package.json
@api/src/server.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Crear estructura Turborepo base</name>
  <files>
    package.json
    turbo.json
    .nvmrc
    .gitignore
  </files>
  <action>
1. Crear archivo `.nvmrc` con `20` (Node 20 LTS)

2. Modificar `package.json` raíz:
   - Agregar `"workspaces": ["apps/*", "packages/*"]`
   - Agregar `"packageManager": "npm@10.0.0"`
   - Renombrar scripts existentes (temporalmente) agregando prefijo `_old_`
   - Agregar nuevos scripts:
     ```json
     "scripts": {
       "build": "turbo run build",
       "dev": "turbo run dev",
       "lint": "turbo run lint",
       "test": "turbo run test",
       "clean": "turbo run clean"
     }
     ```
   - Agregar `turbo` a devDependencies: `"turbo": "^2.4.0"`

3. Crear `turbo.json`:
   ```json
   {
     "$schema": "https://turbo.build/schema.json",
     "tasks": {
       "build": {
         "dependsOn": ["^build"],
         "outputs": ["dist/**", ".next/**", "!.next/cache/**"],
         "env": ["VITE_API_URL", "NODE_ENV"]
       },
       "dev": {
         "cache": false,
         "persistent": true
       },
       "lint": {
         "dependsOn": ["^build"]
       },
       "test": {
         "dependsOn": ["build"]
       },
       "clean": {
         "cache": false
       }
     },
     "globalEnv": ["CI", "VERCEL"]
   }
   ```

4. Actualizar `.gitignore` para incluir:
   - `.turbo`
   - `node_modules` en subdirectorios
   - `dist` en apps

5. NO instalar dependencias todavía (se hace después de mover archivos)
  </action>
  <verify>
    - `cat turbo.json` muestra configuración válida
    - `cat package.json | grep workspaces` muestra la configuración de workspaces
    - `cat .nvmrc` muestra `20`
  </verify>
  <done>
    - turbo.json existe con configuración de tasks
    - package.json tiene workspaces y scripts de turbo
    - .nvmrc especifica Node 20
  </done>
</task>

<task type="auto">
  <name>Task 2: Migrar código existente a estructura apps/packages</name>
  <files>
    apps/web/*
    apps/admin/*
    apps/api/*
    packages/database/*
    packages/shared/*
  </files>
  <action>
1. **Crear estructura de directorios:**
   ```bash
   mkdir -p apps/web apps/admin apps/api packages/database packages/shared
   ```

2. **Migrar frontend a apps/web:**
   - Mover `src/` → `apps/web/src/`
   - Mover `public/` → `apps/web/public/` (si existe)
   - Mover `index.html` → `apps/web/index.html`
   - Mover `vite.config.js` → `apps/web/vite.config.js`
   - Mover `eslint.config.js` → `apps/web/eslint.config.js`
   - Crear `apps/web/package.json`:
     ```json
     {
       "name": "@lapancomido/web",
       "version": "0.0.0",
       "private": true,
       "type": "module",
       "scripts": {
         "dev": "vite",
         "build": "vite build",
         "preview": "vite preview",
         "lint": "eslint ."
       },
       "dependencies": {
         "@lapancomido/shared": "workspace:*",
         "@tailwindcss/vite": "^4.0.1",
         "antd": "^5.23.3",
         "crypto-js": "^4.2.0",
         "framer-motion": "^12.0.6",
         "react": "^18.3.1",
         "react-dom": "^18.3.1",
         "react-icons": "^5.4.0",
         "react-router-dom": "^7.1.3",
         "react-toastify": "^11.0.3",
         "swiper": "^11.2.2",
         "tailwindcss": "^4.0.1"
       },
       "devDependencies": {
         "@eslint/js": "^9.17.0",
         "@types/react": "^18.3.18",
         "@types/react-dom": "^18.3.5",
         "@vitejs/plugin-react": "^4.3.4",
         "eslint": "^9.17.0",
         "eslint-plugin-react": "^7.37.2",
         "eslint-plugin-react-hooks": "^5.0.0",
         "eslint-plugin-react-refresh": "^0.4.16",
         "globals": "^15.14.0",
         "vite": "^6.0.5"
       }
     }
     ```
   - NOTA: Remover dependencias no usadas (@stripe/*, appwrite, dotenv del frontend)

3. **Crear placeholder apps/admin:**
   - Crear `apps/admin/package.json`:
     ```json
     {
       "name": "@lapancomido/admin",
       "version": "0.0.0",
       "private": true,
       "type": "module",
       "scripts": {
         "dev": "vite",
         "build": "vite build",
         "preview": "vite preview",
         "lint": "eslint ."
       },
       "dependencies": {
         "@lapancomido/shared": "workspace:*",
         "@lapancomido/database": "workspace:*"
       }
     }
     ```
   - Crear `apps/admin/index.html` básico
   - Crear `apps/admin/src/main.jsx` con placeholder "Admin Panel - Coming Soon"
   - Crear `apps/admin/vite.config.js` copiando de web

4. **Migrar API a apps/api:**
   - Mover `api/src/` → `apps/api/src/`
   - Mover `api/index.js` → `apps/api/index.js`
   - Mover `api/cloudinaryConfig.js` → `apps/api/cloudinaryConfig.js`
   - Mover `api/tests/` → `apps/api/tests/`
   - Mover `api/jest.config.js` → `apps/api/jest.config.js`
   - Crear `apps/api/package.json`:
     ```json
     {
       "name": "@lapancomido/api",
       "version": "0.0.0",
       "private": true,
       "main": "index.js",
       "scripts": {
         "dev": "nodemon index.js",
         "build": "echo 'No build step for API'",
         "start": "node index.js",
         "test": "jest --coverage",
         "lint": "eslint ."
       },
       "dependencies": {
         "@lapancomido/database": "workspace:*",
         "@lapancomido/shared": "workspace:*",
         "bcrypt": "^5.1.1",
         "cloudinary": "^2.5.1",
         "cors": "^2.8.5",
         "dotenv": "^16.4.7",
         "express": "^4.21.2",
         "jsonwebtoken": "^9.0.2",
         "morgan": "^1.10.0",
         "multer": "^1.4.5-lts.1",
         "pg": "^8.13.1",
         "swagger-jsdoc": "^6.2.8",
         "swagger-ui-express": "^5.0.1"
       },
       "devDependencies": {
         "jest": "^29.7.0",
         "nodemon": "^3.1.9"
       }
     }
     ```

5. **Crear packages/database:**
   - Crear `packages/database/package.json`:
     ```json
     {
       "name": "@lapancomido/database",
       "version": "0.0.0",
       "private": true,
       "main": "./src/index.js",
       "exports": {
         ".": "./src/index.js"
       },
       "scripts": {
         "build": "echo 'No build step'"
       },
       "dependencies": {
         "pg": "^8.13.1",
         "dotenv": "^16.4.7"
       }
     }
     ```
   - Crear `packages/database/src/index.js` que re-exporta el cliente de db:
     ```javascript
     // Temporal: re-exporta el cliente pg existente
     // Será reemplazado por Prisma en Plan 01-02
     const { Pool } = require('pg');
     require('dotenv').config();
     
     const pool = new Pool({
       host: process.env.DB_HOST,
       port: process.env.DB_PORT,
       user: process.env.DB_USER,
       password: process.env.DB_PASSWORD,
       database: process.env.DB_NAME,
       ssl: { rejectUnauthorized: false }
     });
     
     pool.on('connect', (client) => {
       client.query('SET search_path TO pancomido');
     });
     
     module.exports = {
       query: (text, params) => pool.query(text, params),
       pool
     };
     ```

6. **Crear packages/shared:**
   - Crear `packages/shared/package.json`:
     ```json
     {
       "name": "@lapancomido/shared",
       "version": "0.0.0",
       "private": true,
       "main": "./src/index.js",
       "exports": {
         ".": "./src/index.js",
         "./constants": "./src/constants.js"
       },
       "scripts": {
         "build": "echo 'No build step'"
       }
     }
     ```
   - Crear `packages/shared/src/index.js`:
     ```javascript
     // Utilidades compartidas entre apps
     export const formatPrice = (price) => {
       return new Intl.NumberFormat('es-CL', {
         style: 'currency',
         currency: 'CLP'
       }).format(price);
     };
     ```
   - Crear `packages/shared/src/constants.js`:
     ```javascript
     export const WHATSAPP_NUMBER = '+56912345678'; // TODO: Configurar número real
     export const BUSINESS_NAME = 'La Pan Comido';
     ```

7. **Limpiar raíz:**
   - Eliminar directorio `api/` original (ya movido a apps/api)
   - Eliminar `src/` original de la raíz (ya movido a apps/web)
   - Mantener archivos de configuración raíz (package.json, turbo.json, etc.)
  </action>
  <verify>
    - `ls apps/` muestra `web admin api`
    - `ls packages/` muestra `database shared`
    - `cat apps/web/package.json | grep "@lapancomido/shared"` muestra dependencia
    - `cat apps/api/package.json | grep "@lapancomido/database"` muestra dependencia
  </verify>
  <done>
    - Estructura apps/web, apps/admin, apps/api creada
    - Estructura packages/database, packages/shared creada
    - Código existente migrado a nuevas ubicaciones
    - Package.json de cada app/package configurado con dependencias workspace
  </done>
</task>

<task type="auto">
  <name>Task 3: Instalar dependencias y verificar Turborepo</name>
  <files>
    package-lock.json
    node_modules/
  </files>
  <action>
1. **Limpiar node_modules existentes:**
   ```bash
   rm -rf node_modules
   rm -rf apps/*/node_modules
   rm -rf packages/*/node_modules
   rm package-lock.json
   ```

2. **Instalar dependencias desde raíz:**
   ```bash
   npm install
   ```
   Esto instalará todas las dependencias de todos los workspaces

3. **Verificar que turbo funciona:**
   ```bash
   npx turbo build --dry-run
   ```
   Debe mostrar el grafo de dependencias

4. **Probar dev de cada app individualmente:**
   ```bash
   # Verificar que web compila
   npx turbo build --filter=@lapancomido/web
   
   # Verificar que api inicia (sin DB, solo verificar que no crashea)
   cd apps/api && timeout 5 npm run start || true
   ```

5. **Actualizar imports en apps/api para usar @lapancomido/database:**
   - En `apps/api/src/config/db.js`: Cambiar a importar desde `@lapancomido/database`
   - O eliminar `apps/api/src/config/db.js` y actualizar modelos para usar el paquete

6. **Probar turbo dev (solo para verificar que inicia):**
   ```bash
   npx turbo dev &
   sleep 10
   kill %1
   ```
  </action>
  <verify>
    - `npm run build` completa sin errores
    - `npx turbo build --dry-run` muestra grafo de dependencias correcto
    - `ls node_modules/@lapancomido` muestra symlinks a packages locales
  </verify>
  <done>
    - npm install exitoso desde raíz
    - turbo build funciona
    - Dependencias de workspace resuelven correctamente
    - Estructura Turborepo completamente funcional
  </done>
</task>

</tasks>

<verification>
1. `npm run build` desde raíz compila todas las apps
2. `npx turbo build --graph` muestra grafo de dependencias
3. Imports de `@lapancomido/shared` funcionan en apps/web
4. Imports de `@lapancomido/database` funcionan en apps/api
</verification>

<success_criteria>
- Estructura Turborepo con apps/web, apps/admin, apps/api, packages/database, packages/shared
- `npm run dev` inicia todas las apps en paralelo
- `npm run build` compila todas las apps respetando dependencias
- Workspaces de npm resuelven dependencias internas correctamente
</success_criteria>

<output>
After completion, create `.planning/phases/01-fundacion-migracion-db/01-01-SUMMARY.md`
</output>
