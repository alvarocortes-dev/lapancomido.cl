---
phase: 01-fundacion-migracion-db
plan: 03
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - .github/workflows/ci.yml
  - lighthouserc.js
  - apps/web/.env.example
autonomous: true
user_setup:
  - service: github
    why: "GitHub Actions y Lighthouse CI"
    env_vars:
      - name: DATABASE_URL
        source: "GitHub Repo Settings -> Secrets and variables -> Actions -> New repository secret"
      - name: DIRECT_URL
        source: "GitHub Repo Settings -> Secrets and variables -> Actions -> New repository secret"
      - name: VITE_API_URL
        source: "GitHub Repo Settings -> Secrets and variables -> Actions -> New repository secret"
    dashboard_config:
      - task: "Habilitar GitHub Actions"
        location: "GitHub Repo Settings -> Actions -> General -> Allow all actions"
  - service: lhci
    why: "Lighthouse CI status checks en PRs"
    dashboard_config:
      - task: "Instalar Lighthouse CI GitHub App"
        location: "https://github.com/apps/lighthouse-ci -> Configure -> Select repository"

must_haves:
  truths:
    - "Push a main ejecuta workflow CI completo"
    - "PR muestra status check de build/lint/test"
    - "Lighthouse CI reporta scores en cada PR"
  artifacts:
    - path: ".github/workflows/ci.yml"
      provides: "Workflow de CI con build, lint, test, lighthouse"
      contains: "turbo"
    - path: "lighthouserc.js"
      provides: "Configuración de Lighthouse CI"
      contains: "staticDistDir"
  key_links:
    - from: ".github/workflows/ci.yml"
      to: "turbo.json"
      via: "npm run build invokes turbo"
      pattern: "npm run build"
    - from: ".github/workflows/ci.yml"
      to: "lighthouserc.js"
      via: "lhci autorun reads config"
      pattern: "lhci autorun"
---

<objective>
Configurar CI/CD pipeline con GitHub Actions, Lighthouse CI, y preparar para deploy a Vercel.

Purpose: Automatizar build/lint/test en cada PR y reportar performance regression con Lighthouse.
Output: Workflow CI funcional que valida PRs y reporta Lighthouse scores.
</objective>

<execution_context>
@./.opencode/get-shit-done/workflows/execute-plan.md
@./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-fundacion-migracion-db/01-RESEARCH.md
@.planning/phases/01-fundacion-migracion-db/01-01-SUMMARY.md

# Configuración Turborepo
@turbo.json
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Crear workflow GitHub Actions para CI</name>
  <files>
    .github/workflows/ci.yml
  </files>
  <action>
1. **Crear directorio de workflows:**
   ```bash
   mkdir -p .github/workflows
   ```

2. **Crear .github/workflows/ci.yml:**
   ```yaml
   name: CI
   
   on:
     push:
       branches: [main]
     pull_request:
       branches: [main]
   
   env:
     TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
     TURBO_TEAM: ${{ vars.TURBO_TEAM }}
   
   jobs:
     build:
       name: Build & Test
       runs-on: ubuntu-latest
       
       steps:
         - name: Checkout
           uses: actions/checkout@v4
           with:
             fetch-depth: 2
         
         - name: Setup Node.js
           uses: actions/setup-node@v4
           with:
             node-version: 20
             cache: 'npm'
         
         - name: Install dependencies
           run: npm ci
         
         - name: Build
           run: npm run build
           env:
             VITE_API_URL: ${{ secrets.VITE_API_URL }}
         
         - name: Lint
           run: npm run lint
         
         - name: Test
           run: npm run test
           env:
             DATABASE_URL: ${{ secrets.DATABASE_URL }}
             DIRECT_URL: ${{ secrets.DIRECT_URL }}
         
         - name: Upload build artifacts
           uses: actions/upload-artifact@v4
           with:
             name: web-dist
             path: apps/web/dist
             retention-days: 1
   
     lighthouse:
       name: Lighthouse CI
       runs-on: ubuntu-latest
       needs: build
       
       steps:
         - name: Checkout
           uses: actions/checkout@v4
         
         - name: Setup Node.js
           uses: actions/setup-node@v4
           with:
             node-version: 20
             cache: 'npm'
         
         - name: Download build artifacts
           uses: actions/download-artifact@v4
           with:
             name: web-dist
             path: apps/web/dist
         
         - name: Run Lighthouse CI
           run: |
             npm install -g @lhci/cli@0.15.x
             lhci autorun
           env:
             LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}
   ```

3. **Notas importantes:**
   - `fetch-depth: 2` es necesario para que turbo-ignore funcione
   - Build artifacts se pasan entre jobs para Lighthouse
   - TURBO_TOKEN es opcional (para remote caching)
   - LHCI_GITHUB_APP_TOKEN es opcional (para status checks en PRs)
  </action>
  <verify>
    - `cat .github/workflows/ci.yml` muestra workflow válido
    - `yamllint .github/workflows/ci.yml` sin errores (si disponible)
    - Workflow tiene jobs: build y lighthouse
  </verify>
  <done>
    - Workflow CI creado en .github/workflows/ci.yml
    - Job build ejecuta npm ci, build, lint, test
    - Job lighthouse ejecuta lhci autorun
    - Artifacts se pasan entre jobs
  </done>
</task>

<task type="auto">
  <name>Task 2: Configurar Lighthouse CI</name>
  <files>
    lighthouserc.js
    apps/web/.env.example
  </files>
  <action>
1. **Crear lighthouserc.js en raíz del proyecto:**
   ```javascript
   // lighthouserc.js
   module.exports = {
     ci: {
       collect: {
         // Servir archivos estáticos de la build de web
         staticDistDir: './apps/web/dist',
         // Número de runs para promediar resultados
         numberOfRuns: 3,
         // URLs a testear (relativas al servidor local)
         url: ['http://localhost:8080/'],
       },
       assert: {
         // Usar preset recomendado como base
         preset: 'lighthouse:recommended',
         assertions: {
           // Performance: warn at 80%, target 95%+ for Phase 7
           'categories:performance': ['warn', { minScore: 0.8 }],
           // Accessibility: error at 90%, target 100%
           'categories:accessibility': ['error', { minScore: 0.9 }],
           // Best Practices: warn at 90%
           'categories:best-practices': ['warn', { minScore: 0.9 }],
           // SEO: warn at 90%
           'categories:seo': ['warn', { minScore: 0.9 }],
           
           // Desactivar audits que no aplican
           'uses-http2': 'off', // Vercel maneja HTTP/2
           'is-on-https': 'off', // CI corre en localhost
           'redirects-http': 'off', // CI corre en localhost
           
           // Advertencias más permisivas para Phase 1
           'unsized-images': 'warn',
           'uses-responsive-images': 'warn',
         },
       },
       upload: {
         // Storage temporal para ver resultados en CI
         target: 'temporary-public-storage',
       },
     },
   };
   ```

2. **Crear apps/web/.env.example:**
   ```env
   # API URL for development
   VITE_API_URL=http://localhost:3001/api
   
   # API URL for production (set in Vercel)
   # VITE_API_URL=https://api.lapancomido.cl/api
   
   # CryptoJS secret for session encryption
   VITE_CRYPTOJS_SECRET=your-secret-here
   ```

3. **Agregar a .gitignore:**
   ```
   # Lighthouse CI
   .lighthouseci/
   ```

4. **Documentar thresholds actuales:**
   Los thresholds en lighthouserc.js son INICIALES:
   - Performance: 80% (warn) - se aumentará a 95%+ en Phase 7
   - Accessibility: 90% (error) - se aumentará a 100% en Phase 7
   - Best Practices: 90% (warn) - se aumentará a 100% en Phase 7
   - SEO: 90% (warn) - se aumentará a 100% en Phase 7
   
   Esto permite que el CI pase mientras mejoramos iterativamente.
  </action>
  <verify>
    - `cat lighthouserc.js` muestra configuración válida
    - `node -e "require('./lighthouserc.js')"` no arroja errores
    - `cat apps/web/.env.example` muestra variables de entorno
  </verify>
  <done>
    - lighthouserc.js configurado con thresholds iniciales
    - Configuración usa staticDistDir de apps/web/dist
    - .env.example documenta variables requeridas
    - Thresholds permisivos para iteración inicial
  </done>
</task>

<task type="auto">
  <name>Task 3: Verificar pipeline CI localmente</name>
  <files>
    (no new files)
  </files>
  <action>
1. **Simular el workflow CI localmente:**
   ```bash
   # Limpiar y reinstalar
   rm -rf node_modules apps/*/node_modules packages/*/node_modules
   npm ci
   
   # Build
   npm run build
   
   # Lint
   npm run lint
   
   # Test (puede fallar si no hay tests, eso está OK)
   npm run test || echo "Tests skipped or failed - OK for now"
   ```

2. **Probar Lighthouse CI localmente:**
   ```bash
   # Instalar LHCI globalmente
   npm install -g @lhci/cli@0.15.x
   
   # Verificar que la build de web existe
   ls apps/web/dist/
   
   # Ejecutar LHCI (dry run sin upload)
   lhci autorun --collect.settings.chromeFlags="--no-sandbox" || true
   ```
   
   Nota: LHCI puede fallar en algunos entornos sin Chrome instalado. Eso está OK - funcionará en GitHub Actions.

3. **Verificar estructura final de archivos:**
   ```bash
   # Archivos de CI deben existir
   ls -la .github/workflows/ci.yml
   ls -la lighthouserc.js
   
   # Estructura Turborepo debe estar correcta
   ls -la turbo.json
   ls -la apps/
   ls -la packages/
   ```

4. **Commit de configuración CI:**
   Los archivos están listos para commit. El workflow se activará cuando se pushee a GitHub.
  </action>
  <verify>
    - `npm run build` completa sin errores
    - `npm run lint` completa sin errores (o con warnings aceptables)
    - `.github/workflows/ci.yml` existe
    - `lighthouserc.js` existe
  </verify>
  <done>
    - Pipeline CI verificado localmente
    - Build y lint funcionan
    - Lighthouse CI configurado (probará en GitHub Actions)
    - Listo para push a GitHub
  </done>
</task>

</tasks>

<verification>
1. Push a GitHub activa workflow
2. Workflow completa jobs build y lighthouse
3. Lighthouse scores visibles en logs de CI
4. (Opcional) Si LHCI GitHub App instalada: status check en PR
</verification>

<success_criteria>
- GitHub Actions workflow ejecuta en push a main y PRs
- Build, lint, test corren automáticamente
- Lighthouse CI reporta scores (warn/error según thresholds)
- Thresholds iniciales permisivos para iteración
- Pipeline preparado para aumentar thresholds en Phase 7
</success_criteria>

<output>
After completion, create `.planning/phases/01-fundacion-migracion-db/01-03-SUMMARY.md`
</output>
