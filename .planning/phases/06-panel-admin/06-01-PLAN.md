# Plan 06-01: CRUD Productos con Upload Cloudinary

## Goal
Admin puede crear, editar, eliminar productos con imágenes desde el panel admin.

## Prerequisites
- Phase 5 complete (auth system)
- Admin frontend has login UI and navigation shell
- Cloudinary account configured

## Tasks

### API: Schema Update
1. Add `cloudinary_public_id` to `product_img` model in schema.prisma
2. Run `npx prisma generate` to update client

### API: Migrate adminProducts.controller.js to Prisma
3. Rewrite `getAdminProducts` using Prisma
4. Rewrite `createProduct` using Prisma (with categories + stock + images)
5. Rewrite `updateProductDetails` using Prisma (with categories + images)
6. Rewrite `updateStock` using Prisma
7. Rewrite `deleteMultipleProducts` using Prisma (with Cloudinary cleanup)

### API: Add Auth Middleware
8. Create `src/middlewares/requireAuth.js` - validates JWT from header
9. Apply requireAuth middleware to admin.routes.js

### API: Image Upload Endpoint
10. Create `POST /admin/upload` endpoint for Cloudinary uploads (signed)
11. Or configure unsigned upload preset for direct frontend upload

### Admin Frontend: API Client
12. Create `src/api/products.js` - getProducts, createProduct, updateProduct, deleteProducts
13. Create `src/api/upload.js` - uploadImage helper

### Admin Frontend: Products Page
14. Create `src/pages/ProductsPage.jsx`:
    - Table/grid of products with image thumbnail
    - Status toggle (available/agotado)
    - Edit and Delete buttons
    - "Nuevo Producto" button
    - Search/filter

### Admin Frontend: Product Form
15. Create `src/components/ProductForm.jsx`:
    - Fields: nombre, precio, ingredientes, peso, descripción, nutrición
    - Checkbox: disponible
    - Image upload area with drag-and-drop
    - Category multi-select
    - Save/Cancel buttons

16. Create `src/pages/ProductCreatePage.jsx` - wraps ProductForm
17. Create `src/pages/ProductEditPage.jsx` - wraps ProductForm with prefill

### Admin Frontend: Navigation
18. Add Products tab to navigation in main.jsx
19. Add route handling for Products, ProductCreate, ProductEdit pages

## Files to Create
- `apps/api/src/middlewares/requireAuth.js`
- `apps/admin/src/api/products.js`
- `apps/admin/src/api/upload.js`
- `apps/admin/src/pages/ProductsPage.jsx`
- `apps/admin/src/pages/ProductCreatePage.jsx`
- `apps/admin/src/pages/ProductEditPage.jsx`
- `apps/admin/src/components/ProductForm.jsx`
- `apps/admin/src/components/ImageUpload.jsx`

## Files to Modify
- `packages/database/prisma/schema.prisma` - add cloudinary_public_id
- `apps/api/src/controllers/adminProducts.controller.js` - rewrite with Prisma
- `apps/api/src/routes/admin.routes.js` - add auth middleware
- `apps/admin/src/main.jsx` - add navigation and routes

## Verification
- [ ] GET /admin/products returns products with images and categories
- [ ] POST /admin/products creates product with image
- [ ] PUT /admin/products/:id updates product
- [ ] DELETE /admin/products bulk deletes with Cloudinary cleanup
- [ ] Admin can toggle product availability
- [ ] Image upload works and displays correctly
- [ ] Unauthenticated requests return 401

## Estimated Duration
45-60 minutes

---
*Plan created: 2026-02-01*
