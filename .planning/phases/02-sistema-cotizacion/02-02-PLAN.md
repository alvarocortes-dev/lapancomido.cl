---
phase: 02-sistema-cotizacion
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/web/package.json
  - apps/web/src/context/SelectionProvider.jsx
  - apps/web/src/hooks/useSelection.jsx
  - apps/web/src/helpers/whatsapp.helper.js
  - apps/web/src/App.jsx
autonomous: true

must_haves:
  truths:
    - "Selection state persists across component navigation within session"
    - "WhatsApp helper generates valid wa.me links with encoded message"
    - "Selection includes product details, quantity, and pricing"
  artifacts:
    - path: "apps/web/src/context/SelectionProvider.jsx"
      provides: "Selection context with sessionStorage persistence"
      exports: ["SelectionContext", "SelectionProvider"]
    - path: "apps/web/src/hooks/useSelection.jsx"
      provides: "Selection hook with add/update/remove/clear functions"
      exports: ["useSelection"]
    - path: "apps/web/src/helpers/whatsapp.helper.js"
      provides: "WhatsApp link generation logic"
      exports: ["generateWhatsAppLink", "formatWhatsAppMessage"]
  key_links:
    - from: "apps/web/src/hooks/useSelection.jsx"
      to: "apps/web/src/context/SelectionProvider.jsx"
      via: "useContext(SelectionContext)"
      pattern: "useContext.*SelectionContext"
    - from: "apps/web/src/App.jsx"
      to: "apps/web/src/context/SelectionProvider.jsx"
      via: "Provider wrapper"
      pattern: "SelectionProvider"
---

<objective>
Selection state management and WhatsApp helper utilities for quotation system.

Purpose: The quotation flow requires session-based product selection (not localStorage persistent) and properly formatted WhatsApp links. This plan creates the state management infrastructure and message generation utilities used by all UI components.

Output: SelectionProvider/useSelection for product selection state, react-phone-number-input installed, WhatsApp link generation helper.
</objective>

<execution_context>
@./.opencode/get-shit-done/workflows/execute-plan.md
@./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-sistema-cotizacion/02-CONTEXT.md
@.planning/phases/02-sistema-cotizacion/02-RESEARCH.md
@apps/web/src/context/CartProvider.jsx
@apps/web/src/hooks/useCart.jsx
@apps/web/src/helpers/formatPrice.helper.js
@apps/web/src/App.jsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install react-phone-number-input and create SelectionProvider</name>
  <files>
    apps/web/package.json
    apps/web/src/context/SelectionProvider.jsx
  </files>
  <action>
1. Install react-phone-number-input in web app:
```bash
cd apps/web && npm install react-phone-number-input
```

2. Create `apps/web/src/context/SelectionProvider.jsx`:
```jsx
// src/context/SelectionProvider.jsx
import { createContext, useState, useEffect } from "react";

export const SelectionContext = createContext();

const STORAGE_KEY = "PRODUCT_SELECTION";

export const SelectionProvider = ({ children }) => {
  // Initialize from sessionStorage if exists (session persistence, not localStorage)
  const [selection, setSelection] = useState(() => {
    try {
      const stored = sessionStorage.getItem(STORAGE_KEY);
      return stored ? JSON.parse(stored) : [];
    } catch {
      return [];
    }
  });

  // Sync to sessionStorage on change
  useEffect(() => {
    try {
      sessionStorage.setItem(STORAGE_KEY, JSON.stringify(selection));
    } catch (error) {
      console.error("Failed to save selection to sessionStorage:", error);
    }
  }, [selection]);

  return (
    <SelectionContext.Provider value={{ selection, setSelection }}>
      {children}
    </SelectionContext.Provider>
  );
};
```

Note: Uses sessionStorage (not localStorage) per user decision in CONTEXT.md - selection clears when tab closes.
  </action>
  <verify>
```bash
cd apps/web && npm ls react-phone-number-input
ls -la src/context/SelectionProvider.jsx
```
Package installed and file exists.
  </verify>
  <done>
react-phone-number-input installed, SelectionProvider created with sessionStorage persistence.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create useSelection hook and wire to App</name>
  <files>
    apps/web/src/hooks/useSelection.jsx
    apps/web/src/App.jsx
  </files>
  <action>
1. Create `apps/web/src/hooks/useSelection.jsx`:
```jsx
// src/hooks/useSelection.jsx
import { useContext, useCallback } from "react";
import { SelectionContext } from "../context/SelectionProvider";

export const useSelection = () => {
  const { selection, setSelection } = useContext(SelectionContext);

  /**
   * Add product to selection or increment quantity if exists
   * @param {Object} product - Product object with id, product (name), price, unit_type, pack_size, url_img
   * @param {number} quantity - Quantity to add (default 1)
   */
  const addToSelection = useCallback((product, quantity = 1) => {
    setSelection((prev) => {
      const existing = prev.find((item) => item.id === product.id);
      if (existing) {
        return prev.map((item) =>
          item.id === product.id
            ? { ...item, quantity: item.quantity + quantity }
            : item
        );
      }
      return [...prev, { 
        id: product.id,
        product: product.product, // product name
        price: product.price,
        url_img: product.url_img,
        unit_type: product.unit_type || 'unit',
        pack_size: product.pack_size || null,
        quantity 
      }];
    });
  }, [setSelection]);

  /**
   * Update quantity for a specific product
   * @param {number} id - Product ID
   * @param {number} quantity - New quantity (must be >= 1)
   */
  const updateQuantity = useCallback((id, quantity) => {
    if (quantity < 1) return;
    setSelection((prev) =>
      prev.map((item) => (item.id === id ? { ...item, quantity } : item))
    );
  }, [setSelection]);

  /**
   * Remove product from selection
   * @param {number} id - Product ID
   */
  const removeFromSelection = useCallback((id) => {
    setSelection((prev) => prev.filter((item) => item.id !== id));
  }, [setSelection]);

  /**
   * Clear all selections
   */
  const clearSelection = useCallback(() => {
    setSelection([]);
  }, [setSelection]);

  /**
   * Get total number of items (sum of quantities)
   */
  const totalItems = selection.reduce((sum, item) => sum + item.quantity, 0);

  /**
   * Get total price
   */
  const totalPrice = selection.reduce(
    (sum, item) => sum + item.quantity * Number(item.price),
    0
  );

  /**
   * Check if a product is selected
   * @param {number} id - Product ID
   * @returns {Object|undefined} Selected item or undefined
   */
  const getSelectedItem = useCallback((id) => {
    return selection.find((item) => item.id === id);
  }, [selection]);

  return {
    selection,
    addToSelection,
    updateQuantity,
    removeFromSelection,
    clearSelection,
    totalItems,
    totalPrice,
    getSelectedItem,
  };
};
```

2. Update `apps/web/src/App.jsx` to include SelectionProvider:
- Import: `import { SelectionProvider } from "./context/SelectionProvider";`
- Wrap existing providers with SelectionProvider (inside CartProvider, outside ProductProvider):

Find the existing provider hierarchy and add SelectionProvider:
```jsx
<CartProvider>
  <SelectionProvider>
    <ProductProvider>
      {/* existing content */}
    </ProductProvider>
  </SelectionProvider>
</CartProvider>
```

The SelectionProvider should be at the same level as CartProvider - both are session state managers. Place it inside CartProvider for consistency with existing pattern.
  </action>
  <verify>
```bash
cd apps/web && npm run build 2>&1 | head -50
```
Build should succeed without import errors. Check for "SelectionProvider" in build output or error messages.
  </verify>
  <done>
useSelection hook created with add/update/remove/clear functions plus totalItems/totalPrice computed values. SelectionProvider wired into App.jsx provider hierarchy.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create WhatsApp helper with message formatting</name>
  <files>
    apps/web/src/helpers/whatsapp.helper.js
  </files>
  <action>
Create `apps/web/src/helpers/whatsapp.helper.js`:

```javascript
// src/helpers/whatsapp.helper.js
import { formatCLP } from "./formatPrice.helper";

/**
 * Format price for WhatsApp message (without currency symbol for cleaner look)
 * @param {number} value - Price value
 * @returns {string} Formatted price like "$1.500"
 */
const formatPrice = (value) => {
  return formatCLP(value);
};

/**
 * Format a single product line for WhatsApp message
 * @param {Object} product - Product with name, quantity, unit_type, pack_size, price
 * @param {boolean} showPrices - Whether to include prices
 * @returns {string} Formatted product line
 */
const formatProductLine = (product, showPrices) => {
  const { product: name, quantity, unit_type, pack_size, price } = product;
  const lineTotal = quantity * Number(price);
  const unitPrice = Number(price);
  
  let line = `- ${name} x ${quantity}`;
  
  if (unit_type === 'pack' && pack_size) {
    // "x 2 pack (6 un c/p)"
    line += ` pack (${pack_size} un c/p)`;
  } else {
    line += ' un';
  }
  
  if (showPrices) {
    line += ` = ${formatPrice(lineTotal)}`;
    if (quantity > 1) {
      // Show unit price: "($1.000 c/u)" or "($3.000 c/p)"
      line += ` (${formatPrice(unitPrice)} c/${unit_type === 'pack' ? 'p' : 'u'})`;
    }
  }
  
  return line;
};

/**
 * Format the complete WhatsApp message
 * @param {Object} params - Message parameters
 * @param {string} params.customerName - Customer's full name
 * @param {string} params.customerPhone - Customer's phone (E.164 format)
 * @param {Array} params.products - Array of selected products
 * @param {string} params.greeting - Greeting message from admin config
 * @param {boolean} params.showPrices - Whether to show prices
 * @param {string} params.comment - Optional customer comment
 * @returns {string} Complete formatted message
 */
export const formatWhatsAppMessage = ({
  customerName,
  customerPhone,
  products,
  greeting,
  showPrices,
  comment
}) => {
  let message = `${greeting}\n\n`;
  message += `Cliente: ${customerName}\n`;
  message += `Celular: ${customerPhone}\n\n`;
  message += `Productos:\n`;
  
  let total = 0;
  products.forEach((product) => {
    message += formatProductLine(product, showPrices) + '\n';
    total += product.quantity * Number(product.price);
  });
  
  if (showPrices) {
    message += `\nTotal a consultar: ${formatPrice(total)}\n`;
  }
  
  if (comment && comment.trim()) {
    message += `\nComentario: ${comment.trim()}\n`;
  }
  
  message += `\nFavor confirmar stock, gracias!`;
  
  return message;
};

/**
 * Generate WhatsApp wa.me link
 * @param {string} phoneNumber - Store's WhatsApp number (E.164 without +, e.g., "56912345678")
 * @param {Object} params - Message parameters (same as formatWhatsAppMessage)
 * @returns {string} Complete wa.me URL
 */
export const generateWhatsAppLink = (phoneNumber, params) => {
  // Ensure phone number has no + or spaces
  const cleanPhone = phoneNumber.replace(/[+\s-]/g, '');
  
  const message = formatWhatsAppMessage(params);
  
  // Use encodeURIComponent for proper URL encoding (handles emojis, newlines, special chars)
  return `https://wa.me/${cleanPhone}?text=${encodeURIComponent(message)}`;
};
```

This helper:
- Follows the exact message format from CONTEXT.md
- Uses existing formatCLP helper for price formatting
- Handles both unit and pack product types
- Uses encodeURIComponent for safe URL encoding (handles emojis in greeting)
- Keeps phone number clean (no +, spaces, or dashes)
  </action>
  <verify>
```bash
cd apps/web && npm run build 2>&1 | head -20
```
Build should succeed. The helper imports formatPrice.helper.js which already exists.
  </verify>
  <done>
WhatsApp helper created with formatWhatsAppMessage and generateWhatsAppLink functions. Follows exact message format from CONTEXT.md, handles unit/pack products, uses proper URL encoding.
  </done>
</task>

</tasks>

<verification>
1. `npm ls react-phone-number-input` shows package installed in apps/web
2. SelectionProvider.jsx exports SelectionContext and SelectionProvider
3. useSelection.jsx exports useSelection hook with all CRUD functions
4. whatsapp.helper.js exports generateWhatsAppLink and formatWhatsAppMessage
5. App.jsx imports and wraps content with SelectionProvider
6. `npm run build` succeeds in apps/web
</verification>

<success_criteria>
- react-phone-number-input installed in apps/web
- SelectionProvider uses sessionStorage (not localStorage)
- useSelection provides addToSelection, updateQuantity, removeFromSelection, clearSelection
- useSelection provides totalItems, totalPrice computed values
- WhatsApp helper generates properly encoded wa.me links
- Message format matches CONTEXT.md specification exactly
- App.jsx includes SelectionProvider in provider hierarchy
- Build succeeds without errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-sistema-cotizacion/02-02-SUMMARY.md`
</output>
