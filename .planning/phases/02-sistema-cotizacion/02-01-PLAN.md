---
phase: 02-sistema-cotizacion
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/database/prisma/schema.prisma
  - apps/api/src/routes/store.routes.js
  - apps/api/src/controllers/store.controller.js
  - apps/api/src/routes/routes.js
autonomous: true

must_haves:
  truths:
    - "API returns store configuration (whatsapp_number, greeting, show_prices)"
    - "Products can have unit_type (unit/pack) and pack_size fields"
    - "Store config is publicly accessible without authentication"
  artifacts:
    - path: "packages/database/prisma/schema.prisma"
      provides: "store_config model, product unit_type/pack_size fields"
      contains: "model store_config"
    - path: "apps/api/src/routes/store.routes.js"
      provides: "Store config route definitions"
      exports: ["router"]
    - path: "apps/api/src/controllers/store.controller.js"
      provides: "Store config controller"
      exports: ["getStoreConfig"]
  key_links:
    - from: "apps/api/src/routes/store.routes.js"
      to: "apps/api/src/controllers/store.controller.js"
      via: "router.get('/config', getStoreConfig)"
      pattern: "getStoreConfig"
    - from: "apps/api/src/controllers/store.controller.js"
      to: "prisma.store_config"
      via: "Prisma query"
      pattern: "prisma\\.store_config"
---

<objective>
Database schema updates and store config API for quotation system foundation.

Purpose: The quotation flow needs store configuration (WhatsApp number, greeting message, price visibility toggle) and product unit types for proper message formatting. This foundation enables all subsequent UI work.

Output: Extended Prisma schema with store_config model and product unit fields, plus public API endpoint for store configuration.
</objective>

<execution_context>
@./.opencode/get-shit-done/workflows/execute-plan.md
@./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-sistema-cotizacion/02-CONTEXT.md
@.planning/phases/02-sistema-cotizacion/02-RESEARCH.md
@packages/database/prisma/schema.prisma
@apps/api/src/routes/routes.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend Prisma schema with store_config and product fields</name>
  <files>
    packages/database/prisma/schema.prisma
    packages/database/prisma/migrations/[timestamp]_add_store_config/migration.sql
  </files>
  <action>
Add to packages/database/prisma/schema.prisma:

1. Create `store_config` model:
```prisma
model store_config {
  id               Int      @id @default(autoincrement())
  whatsapp_number  String   // E.164 format without +, e.g., "56912345678"
  greeting         String   @default("Hola! Hay pan? <3")
  show_prices      Boolean  @default(true)
  created_at       DateTime @default(now())
  updated_at       DateTime @default(now()) @updatedAt

  @@schema("pancomido")
}
```

2. Add unit fields to existing `products` model:
```prisma
// Add after existing fields
unit_type   String   @default("unit")  // "unit" or "pack"
pack_size   Int?                        // Only for packs, e.g., 6 means "6 un c/p"
```

3. Create `quotation_leads` model for storing customer emails:
```prisma
model quotation_leads {
  id         Int      @id @default(autoincrement())
  email      String?
  phone      String   // E.164 format
  name       String
  created_at DateTime @default(now())

  @@schema("pancomido")
}
```

4. Run `npx prisma generate` in packages/database to regenerate client.

5. Create migration (do NOT apply - schema is already synced manually):
```bash
cd packages/database
npx prisma migrate dev --create-only --name add_store_config
```

Note: Migration will be marked as applied on production database manually.
  </action>
  <verify>
```bash
cd packages/database && npx prisma validate && npx prisma generate
```
Should complete without errors. Check that `store_config`, `quotation_leads` models exist and `products` has `unit_type`, `pack_size` fields.
  </verify>
  <done>
Prisma schema extended with store_config model, quotation_leads model, and product unit fields. Client regenerated successfully.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create store config API endpoint</name>
  <files>
    apps/api/src/controllers/store.controller.js
    apps/api/src/routes/store.routes.js
    apps/api/src/routes/routes.js
  </files>
  <action>
1. Create `apps/api/src/controllers/store.controller.js`:
```javascript
const { prisma } = require('@lapancomido/database');

/**
 * Get public store configuration
 * Returns config needed for quotation flow (whatsapp number, greeting, price visibility)
 */
const getStoreConfig = async (req, res, next) => {
  try {
    // Get first (and only) store config record
    let config = await prisma.store_config.findFirst();
    
    // If no config exists, create default
    if (!config) {
      config = await prisma.store_config.create({
        data: {
          whatsapp_number: '56900000000', // Placeholder - admin must update
          greeting: 'Hola! Hay pan? <3',
          show_prices: true
        }
      });
    }
    
    res.json({
      whatsapp_number: config.whatsapp_number,
      greeting: config.greeting,
      show_prices: config.show_prices
    });
  } catch (error) {
    next(error);
  }
};

module.exports = { getStoreConfig };
```

2. Create `apps/api/src/routes/store.routes.js`:
```javascript
const express = require('express');
const router = express.Router();
const { getStoreConfig } = require('../controllers/store.controller');

/**
 * @swagger
 * /api/store/config:
 *   get:
 *     summary: Get public store configuration
 *     tags: [Store]
 *     responses:
 *       200:
 *         description: Store configuration
 *         content:
 *           application/json:
 *             schema:
 *               type: object
 *               properties:
 *                 whatsapp_number:
 *                   type: string
 *                   example: "56912345678"
 *                 greeting:
 *                   type: string
 *                   example: "Hola! Hay pan? <3"
 *                 show_prices:
 *                   type: boolean
 *                   example: true
 */
router.get('/config', getStoreConfig);

module.exports = router;
```

3. Register in `apps/api/src/routes/routes.js`:
- Import: `const storeRoutes = require('./store.routes');`
- Mount: `router.use('/store', storeRoutes);`

Add these near the existing route imports and mounts, following the same pattern.
  </action>
  <verify>
```bash
cd apps/api && npm run dev &
sleep 3
curl http://localhost:3000/api/store/config
```
Should return JSON with `whatsapp_number`, `greeting`, `show_prices` fields. Kill the dev server after test.
  </verify>
  <done>
GET /api/store/config endpoint returns store configuration. Public endpoint (no auth required) returns whatsapp_number, greeting, and show_prices fields.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create quotation leads API endpoint</name>
  <files>
    apps/api/src/controllers/store.controller.js
    apps/api/src/routes/store.routes.js
  </files>
  <action>
1. Add to `apps/api/src/controllers/store.controller.js`:
```javascript
/**
 * Save customer lead from quotation
 * Stores email for future promotions (email not included in WhatsApp message)
 */
const saveQuotationLead = async (req, res, next) => {
  try {
    const { name, phone, email } = req.body;
    
    if (!name || !phone) {
      return res.status(400).json({ error: 'Name and phone are required' });
    }
    
    const lead = await prisma.quotation_leads.create({
      data: {
        name: name.trim(),
        phone: phone.trim(),
        email: email?.trim() || null
      }
    });
    
    res.status(201).json({ id: lead.id });
  } catch (error) {
    next(error);
  }
};

// Update module.exports to include new function
module.exports = { getStoreConfig, saveQuotationLead };
```

2. Add route to `apps/api/src/routes/store.routes.js`:
```javascript
const { getStoreConfig, saveQuotationLead } = require('../controllers/store.controller');

/**
 * @swagger
 * /api/store/lead:
 *   post:
 *     summary: Save customer lead from quotation
 *     tags: [Store]
 *     requestBody:
 *       required: true
 *       content:
 *         application/json:
 *           schema:
 *             type: object
 *             required:
 *               - name
 *               - phone
 *             properties:
 *               name:
 *                 type: string
 *               phone:
 *                 type: string
 *               email:
 *                 type: string
 *     responses:
 *       201:
 *         description: Lead saved
 */
router.post('/lead', saveQuotationLead);
```
  </action>
  <verify>
```bash
curl -X POST http://localhost:3000/api/store/lead \
  -H "Content-Type: application/json" \
  -d '{"name":"Test User","phone":"+56912345678","email":"test@example.com"}'
```
Should return 201 with `{"id": <number>}`.
  </verify>
  <done>
POST /api/store/lead endpoint saves customer email/phone for future promotions. Returns lead ID on success.
  </done>
</task>

</tasks>

<verification>
1. Prisma schema validates: `cd packages/database && npx prisma validate`
2. Prisma client generates: `cd packages/database && npx prisma generate`
3. GET /api/store/config returns configuration JSON
4. POST /api/store/lead accepts and stores customer data
5. No authentication required for either endpoint (public)
</verification>

<success_criteria>
- store_config model exists in Prisma schema with whatsapp_number, greeting, show_prices
- quotation_leads model exists for storing customer emails
- products model has unit_type and pack_size fields
- GET /api/store/config returns store configuration
- POST /api/store/lead stores customer lead data
- All endpoints work without authentication
</success_criteria>

<output>
After completion, create `.planning/phases/02-sistema-cotizacion/02-01-SUMMARY.md`
</output>
