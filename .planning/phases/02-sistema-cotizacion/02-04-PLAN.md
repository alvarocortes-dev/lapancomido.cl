---
phase: 02-sistema-cotizacion
plan: 04
type: execute
wave: 3
depends_on: ["02-03"]
files_modified:
  - apps/web/src/components/selection/QuotationModal.jsx
  - apps/web/src/pages/CatalogPage.jsx
  - apps/web/src/index.css
autonomous: false

must_haves:
  truths:
    - "User can open quotation modal from SelectionBar"
    - "Modal shows selected products with edit capabilities"
    - "User can enter name and phone (required), email and comment (optional)"
    - "Phone input has country selector with Chile pre-selected"
    - "Submit generates WhatsApp link and opens WhatsApp"
    - "Customer email is saved to database for future promotions"
  artifacts:
    - path: "apps/web/src/components/selection/QuotationModal.jsx"
      provides: "Quotation modal with customer form and WhatsApp generation"
      min_lines: 100
  key_links:
    - from: "apps/web/src/components/selection/QuotationModal.jsx"
      to: "apps/web/src/helpers/whatsapp.helper.js"
      via: "generateWhatsAppLink import"
      pattern: "generateWhatsAppLink"
    - from: "apps/web/src/components/selection/QuotationModal.jsx"
      to: "apps/web/src/hooks/useSelection.jsx"
      via: "useSelection hook"
      pattern: "useSelection"
    - from: "apps/web/src/pages/CatalogPage.jsx"
      to: "apps/web/src/components/selection/QuotationModal.jsx"
      via: "Component import and render"
      pattern: "QuotationModal"
---

<objective>
Quotation modal with customer form, product editing, and WhatsApp link generation.

Purpose: Complete the quotation flow by allowing users to enter their contact information and submit a structured request via WhatsApp. This is the final step where selection becomes action.

Output: QuotationModal component with phone input, product summary editing, and WhatsApp link generation. Human verification checkpoint for full flow testing.
</objective>

<execution_context>
@./.opencode/get-shit-done/workflows/execute-plan.md
@./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-sistema-cotizacion/02-CONTEXT.md
@.planning/phases/02-sistema-cotizacion/02-RESEARCH.md
@apps/web/src/hooks/useSelection.jsx
@apps/web/src/helpers/whatsapp.helper.js
@apps/web/src/components/selection/SelectionBar.jsx
@apps/web/src/pages/CatalogPage.jsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create QuotationModal component with phone input</name>
  <files>
    apps/web/src/components/selection/QuotationModal.jsx
    apps/web/src/index.css
  </files>
  <action>
1. Create `apps/web/src/components/selection/QuotationModal.jsx`:

```jsx
// src/components/selection/QuotationModal.jsx
import { useState } from "react";
import { Modal, Input, Button, Form, message } from "antd";
import { DeleteOutlined } from "@ant-design/icons";
import PhoneInput from "react-phone-number-input";
import { isPossiblePhoneNumber } from "react-phone-number-input";
import es from "react-phone-number-input/locale/es";
import "react-phone-number-input/style.css";

import { useSelection } from "../../hooks/useSelection";
import { formatCLP } from "../../helpers/formatPrice.helper";
import { generateWhatsAppLink } from "../../helpers/whatsapp.helper";
import { QuantityControl } from "../catalog/QuantityControl";

const { TextArea } = Input;

/**
 * Quotation modal with customer form and WhatsApp submission
 * @param {boolean} open - Modal visibility
 * @param {function} onClose - Called when modal closes
 * @param {Object} storeConfig - Store configuration (whatsapp_number, greeting, show_prices)
 */
export const QuotationModal = ({ open, onClose, storeConfig }) => {
  const { 
    selection, 
    totalPrice, 
    updateQuantity, 
    removeFromSelection,
    clearSelection 
  } = useSelection();
  
  const [form, setForm] = useState({
    name: "",
    phone: "",
    email: "",
    comment: ""
  });
  const [errors, setErrors] = useState({});
  const [submitting, setSubmitting] = useState(false);

  const handleChange = (field, value) => {
    setForm((prev) => ({ ...prev, [field]: value }));
    // Clear error when user types
    if (errors[field]) {
      setErrors((prev) => ({ ...prev, [field]: null }));
    }
  };

  const validate = () => {
    const newErrors = {};
    
    if (!form.name.trim()) {
      newErrors.name = "Nombre requerido";
    }
    
    if (!form.phone) {
      newErrors.phone = "Celular requerido";
    } else if (!isPossiblePhoneNumber(form.phone)) {
      newErrors.phone = "Celular inválido";
    }
    
    setErrors(newErrors);
    return Object.keys(newErrors).length === 0;
  };

  const saveCustomerLead = async () => {
    try {
      await fetch(`${import.meta.env.VITE_API_URL}/api/store/lead`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          name: form.name.trim(),
          phone: form.phone,
          email: form.email.trim() || null
        })
      });
    } catch (error) {
      // Don't block the WhatsApp flow if lead save fails
      console.error("Failed to save customer lead:", error);
    }
  };

  const handleSubmit = async () => {
    if (!validate()) return;
    if (selection.length === 0) {
      message.warning("No hay productos seleccionados");
      return;
    }

    setSubmitting(true);

    try {
      // Save customer email for future promotions (async, don't block)
      saveCustomerLead();

      // Generate WhatsApp link
      const link = generateWhatsAppLink(storeConfig.whatsapp_number, {
        customerName: form.name.trim(),
        customerPhone: form.phone,
        products: selection,
        greeting: storeConfig.greeting,
        showPrices: storeConfig.show_prices,
        comment: form.comment.trim()
      });

      // Open WhatsApp in new tab
      window.open(link, "_blank");

      // Clear selection and close modal
      clearSelection();
      setForm({ name: "", phone: "", email: "", comment: "" });
      onClose();
      
      message.success("Redirigiendo a WhatsApp...");
    } catch (error) {
      console.error("Failed to generate WhatsApp link:", error);
      message.error("Error al generar enlace de WhatsApp");
    } finally {
      setSubmitting(false);
    }
  };

  const handleCancel = () => {
    setErrors({});
    onClose();
  };

  return (
    <Modal
      title="Cotización"
      open={open}
      onCancel={handleCancel}
      width={600}
      footer={[
        <Button key="cancel" onClick={handleCancel}>
          Cancelar
        </Button>,
        <Button
          key="submit"
          type="primary"
          loading={submitting}
          onClick={handleSubmit}
          className="!bg-green-600 !border-green-600 hover:!bg-green-700"
          disabled={selection.length === 0}
        >
          Consultar por stock
        </Button>
      ]}
    >
      {/* Product Summary */}
      <div className="mb-6">
        <h4 className="font-semibold mb-3">Productos seleccionados</h4>
        <div className="max-h-[200px] overflow-y-auto space-y-2 bg-gray-50 p-3 rounded-lg">
          {selection.map((item) => (
            <div
              key={item.id}
              className="flex items-center gap-3 bg-white p-2 rounded"
            >
              <img
                src={item.url_img}
                alt={item.product}
                className="w-10 h-10 object-cover rounded"
              />
              <div className="flex-1 min-w-0">
                <p className="font-medium truncate text-sm">{item.product}</p>
              </div>
              <QuantityControl
                quantity={item.quantity}
                onIncrease={() => updateQuantity(item.id, item.quantity + 1)}
                onDecrease={() => updateQuantity(item.id, item.quantity - 1)}
                onRemove={() => removeFromSelection(item.id)}
                size="small"
              />
              {storeConfig.show_prices && (
                <p className="font-semibold text-sm min-w-[60px] text-right">
                  {formatCLP(item.quantity * Number(item.price))}
                </p>
              )}
              <Button
                type="text"
                size="small"
                danger
                icon={<DeleteOutlined />}
                onClick={() => removeFromSelection(item.id)}
              />
            </div>
          ))}
        </div>
        {storeConfig.show_prices && (
          <div className="flex justify-end mt-2 pr-2">
            <span className="font-semibold">
              Total: {formatCLP(totalPrice)}
            </span>
          </div>
        )}
      </div>

      {/* Customer Form */}
      <Form layout="vertical">
        <Form.Item
          label="Nombre completo"
          required
          validateStatus={errors.name ? "error" : ""}
          help={errors.name}
        >
          <Input
            placeholder="Tu nombre"
            value={form.name}
            onChange={(e) => handleChange("name", e.target.value)}
          />
        </Form.Item>

        <Form.Item
          label="Celular"
          required
          validateStatus={errors.phone ? "error" : ""}
          help={errors.phone}
        >
          <PhoneInput
            international
            defaultCountry="CL"
            labels={es}
            value={form.phone}
            onChange={(phone) => handleChange("phone", phone || "")}
            placeholder="Ingresa tu celular"
            className="phone-input-custom"
          />
        </Form.Item>

        <Form.Item label="Email (opcional)">
          <Input
            type="email"
            placeholder="Para recibir promociones"
            value={form.email}
            onChange={(e) => handleChange("email", e.target.value)}
          />
        </Form.Item>

        <Form.Item label="Comentarios (opcional)">
          <TextArea
            rows={2}
            placeholder="Instrucciones especiales, horario de entrega, etc."
            value={form.comment}
            onChange={(e) => handleChange("comment", e.target.value)}
            maxLength={500}
          />
        </Form.Item>
      </Form>
    </Modal>
  );
};
```

2. Add phone input styling overrides to `apps/web/src/index.css`:

Add at the end of the file:
```css
/* react-phone-number-input customization */
.phone-input-custom {
  display: flex;
  align-items: center;
}

.phone-input-custom .PhoneInputCountry {
  margin-right: 8px;
}

.phone-input-custom .PhoneInputInput {
  flex: 1;
  padding: 4px 11px;
  border: 1px solid #d9d9d9;
  border-radius: 6px;
  font-size: 14px;
  line-height: 1.5714285714285714;
  transition: all 0.2s;
}

.phone-input-custom .PhoneInputInput:hover {
  border-color: #4096ff;
}

.phone-input-custom .PhoneInputInput:focus {
  border-color: #4096ff;
  box-shadow: 0 0 0 2px rgba(5, 145, 255, 0.1);
  outline: none;
}

.phone-input-custom .PhoneInputCountrySelect {
  background: transparent;
  border: none;
  font-size: 14px;
}

.phone-input-custom .PhoneInputCountryIcon {
  width: 24px;
  height: 18px;
}
```

These styles make the phone input match Ant Design's input styling.
  </action>
  <verify>
```bash
cd apps/web && npm run build 2>&1 | grep -i error || echo "Build successful"
```
Build should succeed with no import errors.
  </verify>
  <done>
QuotationModal component created with:
- Product summary with edit/remove capabilities
- Name (required) and Phone (required) inputs
- Email (optional) and Comment (optional) inputs
- Phone input with Chile pre-selected country
- WhatsApp link generation and window.open
- Customer lead saving for future promotions
- Proper styling for phone input to match Ant Design
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire QuotationModal to CatalogPage</name>
  <files>
    apps/web/src/pages/CatalogPage.jsx
  </files>
  <action>
Update `apps/web/src/pages/CatalogPage.jsx` to add QuotationModal:

1. Add import at top:
```jsx
import { QuotationModal } from "../components/selection/QuotationModal";
```

2. The `quotationModalOpen` state and `setQuotationModalOpen` should already exist from Plan 03. If not, add:
```jsx
const [quotationModalOpen, setQuotationModalOpen] = useState(false);
```

3. Add QuotationModal component at the end of the return statement (before closing container div, after SelectionBar):
```jsx
<QuotationModal
  open={quotationModalOpen}
  onClose={() => setQuotationModalOpen(false)}
  storeConfig={storeConfig}
/>
```

The complete structure near the end of CatalogPage should be:
```jsx
      {/* Pagination */}
      <div className="flex justify-center mt-8 space-x-2">
        {/* ... existing pagination ... */}
      </div>

      {/* Selection Bar */}
      <SelectionBar 
        onQuoteClick={() => setQuotationModalOpen(true)}
        showPrices={storeConfig.show_prices}
      />

      {/* Quotation Modal */}
      <QuotationModal
        open={quotationModalOpen}
        onClose={() => setQuotationModalOpen(false)}
        storeConfig={storeConfig}
      />
    </div>
  );
};
```
  </action>
  <verify>
```bash
cd apps/web && npm run build 2>&1 | grep -i error || echo "Build successful"
```
Build succeeds. QuotationModal is imported and rendered.
  </verify>
  <done>
QuotationModal wired to CatalogPage. Opens when "Cotizar" button in SelectionBar is clicked. Receives storeConfig for WhatsApp number, greeting, and price visibility.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify complete quotation flow</name>
  <what-built>
Complete quotation flow:
1. Catalog page with products showing "Agregar" button
2. Clicking Agregar changes to +/- quantity controls
3. Selection bar appears at bottom with item count and "Cotizar" button
4. Clicking "Cotizar" opens modal with product summary
5. Modal has name, phone (with country selector), email, comment fields
6. "Consultar por stock" button generates WhatsApp link and opens WhatsApp
  </what-built>
  <how-to-verify>
1. Start the dev server: `cd apps/web && npm run dev`
2. Open http://localhost:3001/catalog (or configured port)
3. Verify product cards show:
   - Product image and name
   - "Agregar" button on available products
   - "Agotado" text on out-of-stock products (if any)
4. Click "Agregar" on a product:
   - Button should change to +/- quantity controls
   - Selection bar should appear at bottom
5. Add 2-3 products with different quantities
6. Verify selection bar shows:
   - Correct product count
   - Correct total price
   - "Cotizar" button
7. Click the expand arrow on selection bar:
   - Should show list of selected products
   - Should allow editing quantities
   - Should have "Limpiar" button
8. Click "Cotizar" button:
   - Modal should open with product summary
   - Products should be editable in modal
9. Fill in the form:
   - Name: "Test User"
   - Phone: Select Chile, enter "912345678"
   - Email: optional
   - Comment: optional
10. Click "Consultar por stock":
    - Should open WhatsApp Web or app with pre-formatted message
    - Message should include greeting, customer info, product list, total
11. After opening WhatsApp:
    - Selection should be cleared
    - Modal should close
    - Selection bar should disappear

Expected: All steps complete successfully. WhatsApp opens with correctly formatted message matching the format in CONTEXT.md.
  </how-to-verify>
  <resume-signal>Type "approved" if flow works correctly, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
1. QuotationModal.jsx exists and exports QuotationModal component
2. CatalogPage.jsx imports and renders QuotationModal
3. Phone input shows country selector with Chile pre-selected
4. Form validates name and phone as required
5. WhatsApp link opens correctly formatted message
6. Customer lead is saved to database
7. Selection clears after successful submission
</verification>

<success_criteria>
- Modal opens from SelectionBar "Cotizar" button
- Modal shows editable product summary
- Phone input has country selector with Chile (+56) default
- Name and phone are required, email and comment optional
- "Consultar por stock" generates wa.me link with proper format
- WhatsApp opens with message matching CONTEXT.md format
- Customer email saved to quotation_leads table
- Selection clears after successful submission
- Human verification confirms complete flow works
</success_criteria>

<output>
After completion, create `.planning/phases/02-sistema-cotizacion/02-04-SUMMARY.md`
</output>
