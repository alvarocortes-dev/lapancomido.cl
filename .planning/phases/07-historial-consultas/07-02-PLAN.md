---
phase: 07-historial-consultas
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - apps/api/src/controllers/consultations.controller.js
  - apps/api/src/routes/admin.routes.js
  - apps/admin/src/api/consultations.js
  - apps/admin/src/pages/ConsultationsPage.jsx
  - apps/admin/src/components/ConsultationDetailModal.jsx
  - apps/admin/src/main.jsx
autonomous: true

must_haves:
  truths:
    - "Admin puede ver listado de consultas recientes"
    - "Lista muestra fecha, nombre, teléfono, cantidad productos, total"
    - "Default filter: últimos 30 días"
    - "Admin puede ver detalle de cada consulta con productos"
    - "Click en fila abre modal con detalle completo"
  artifacts:
    - path: "apps/admin/src/pages/ConsultationsPage.jsx"
      provides: "Historia de consultas con filtros y paginación"
      min_lines: 100
    - path: "apps/admin/src/components/ConsultationDetailModal.jsx"
      provides: "Modal con detalle de consulta y productos"
      min_lines: 50
    - path: "apps/api/src/controllers/consultations.controller.js"
      provides: "getConsultations admin endpoint"
      exports: ["saveConsultation", "getConsultations"]
  key_links:
    - from: "apps/admin/src/pages/ConsultationsPage.jsx"
      to: "/api/admin/consultations"
      via: "fetch with auth token"
      pattern: "consultationsApi\\.getConsultations"
    - from: "apps/admin/src/main.jsx"
      to: "ConsultationsPage"
      via: "navigation tab"
      pattern: "currentPage.*consultations"
---

<objective>
Implementar vista de historial de consultas en el panel admin con filtros y detalle.

Purpose: El admin puede revisar todas las consultas WhatsApp recibidas, filtrar por fecha/nombre, y ver el detalle de productos de cada una.

Output: ConsultationsPage con tabla paginada, filtros de fecha/nombre, modal de detalle, y navegación en admin.
</objective>

<execution_context>
@./.opencode/get-shit-done/workflows/execute-plan.md
@./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-historial-consultas/07-CONTEXT.md
@.planning/phases/07-historial-consultas/07-RESEARCH.md
@.planning/phases/07-historial-consultas/07-01-SUMMARY.md

# Source files
@apps/admin/src/main.jsx
@apps/admin/src/pages/ProductsPage.jsx
@apps/api/src/routes/admin.routes.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Admin API endpoint for consultations list</name>
  <files>
apps/api/src/controllers/consultations.controller.js
apps/api/src/routes/admin.routes.js
  </files>
  <action>
Add `getConsultations` function to `apps/api/src/controllers/consultations.controller.js`:

```javascript
/**
 * Get consultations with pagination and filters (admin endpoint)
 * Supports: page, limit, from, to, search (by customer name)
 */
export const getConsultations = async (req, res, next) => {
  try {
    const { 
      page = 1, 
      limit = 15, 
      from, 
      to, 
      search 
    } = req.query;

    const skip = (parseInt(page) - 1) * parseInt(limit);
    const take = parseInt(limit);

    // Build where clause
    const where = {};

    // Date range filter
    if (from || to) {
      where.created_at = {};
      if (from) where.created_at.gte = new Date(from);
      if (to) where.created_at.lte = new Date(to);
    }

    // Search by customer name (case insensitive)
    if (search) {
      where.customer_name = { 
        contains: search, 
        mode: 'insensitive' 
      };
    }

    // Execute queries in parallel
    const [items, total] = await Promise.all([
      prisma.consultations.findMany({
        where,
        include: { items: true },
        orderBy: { created_at: 'desc' },
        skip,
        take
      }),
      prisma.consultations.count({ where })
    ]);

    res.json({ 
      items, 
      total, 
      page: parseInt(page), 
      limit: take 
    });
  } catch (error) {
    next(error);
  }
};
```

Add route to `apps/api/src/routes/admin.routes.js`:

```javascript
import * as consultationsController from '../controllers/consultations.controller.js';

// After existing admin routes, add:
router.get('/consultations', consultationsController.getConsultations);
```

Note: This route is protected by requireAuth + requireAdmin middleware (already applied via router.use at top of file).
  </action>
  <verify>
```bash
# Get token first, then:
curl -H "Authorization: Bearer $TOKEN" \
  "http://localhost:3000/api/admin/consultations?page=1&limit=10"
```
Returns `{"items": [...], "total": N, "page": 1, "limit": 10}`
  </verify>
  <done>
- GET /api/admin/consultations returns paginated list
- Supports from/to date filters
- Supports search by customer name
- Includes consultation items in response
  </done>
</task>

<task type="auto">
  <name>Task 2: Admin frontend API helper + ConsultationsPage</name>
  <files>
apps/admin/src/api/consultations.js
apps/admin/src/pages/ConsultationsPage.jsx
apps/admin/src/components/ConsultationDetailModal.jsx
  </files>
  <action>
Create `apps/admin/src/api/consultations.js`:

```javascript
const API_URL = import.meta.env.VITE_API_URL;

export const consultationsApi = {
  async getConsultations(token, params) {
    const url = new URL(`${API_URL}/api/admin/consultations`);
    Object.entries(params).forEach(([key, value]) => {
      if (value != null && value !== '') {
        url.searchParams.append(key, value);
      }
    });

    const res = await fetch(url, {
      headers: { Authorization: `Bearer ${token}` }
    });

    if (!res.ok) throw new Error('Failed to fetch consultations');
    return res.json();
  }
};
```

Create `apps/admin/src/pages/ConsultationsPage.jsx`:

```jsx
import { useState, useEffect } from 'react';
import { Table, DatePicker, Input, Empty, Spin } from 'antd';
import dayjs from 'dayjs';
import { useAuth } from '../context/AuthContext';
import { consultationsApi } from '../api/consultations';
import ConsultationDetailModal from '../components/ConsultationDetailModal';

const { RangePicker } = DatePicker;

// Format price as CLP
const formatCLP = (value) => {
  const num = Number(value);
  return num.toLocaleString('es-CL', { style: 'currency', currency: 'CLP', minimumFractionDigits: 0 });
};

// Format phone for display
const formatPhoneDisplay = (phone) => {
  if (!phone) return '';
  // Already formatted with country code
  return phone;
};

export default function ConsultationsPage() {
  const { token } = useAuth();
  const [consultations, setConsultations] = useState([]);
  const [loading, setLoading] = useState(true);
  const [pagination, setPagination] = useState({ current: 1, pageSize: 15, total: 0 });
  
  // Default to last 30 days
  const [dateRange, setDateRange] = useState([
    dayjs().subtract(30, 'day'),
    dayjs()
  ]);
  const [searchName, setSearchName] = useState('');
  const [selectedConsultation, setSelectedConsultation] = useState(null);

  const loadConsultations = async () => {
    setLoading(true);
    try {
      const params = {
        page: pagination.current,
        limit: pagination.pageSize,
        from: dateRange?.[0]?.startOf('day').toISOString(),
        to: dateRange?.[1]?.endOf('day').toISOString(),
        search: searchName || undefined
      };

      const data = await consultationsApi.getConsultations(token, params);
      setConsultations(data.items);
      setPagination(prev => ({ ...prev, total: data.total }));
    } catch (error) {
      console.error('Failed to load consultations:', error);
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    loadConsultations();
  }, [pagination.current, dateRange, searchName]);

  const handleTableChange = (pag) => {
    setPagination(prev => ({ ...prev, current: pag.current, pageSize: pag.pageSize }));
  };

  const handleDateChange = (dates) => {
    setDateRange(dates);
    setPagination(prev => ({ ...prev, current: 1 })); // Reset to page 1
  };

  const handleSearch = (value) => {
    setSearchName(value);
    setPagination(prev => ({ ...prev, current: 1 })); // Reset to page 1
  };

  const columns = [
    {
      title: 'Fecha',
      dataIndex: 'created_at',
      key: 'created_at',
      render: (date) => dayjs(date).format('DD/MM/YYYY HH:mm'),
      width: 150
    },
    {
      title: 'Cliente',
      dataIndex: 'customer_name',
      key: 'customer_name',
      ellipsis: true
    },
    {
      title: 'Celular',
      dataIndex: 'customer_phone',
      key: 'customer_phone',
      render: formatPhoneDisplay,
      width: 150
    },
    {
      title: 'Productos',
      dataIndex: 'product_count',
      key: 'product_count',
      align: 'center',
      width: 100
    },
    {
      title: 'Total',
      dataIndex: 'total_amount',
      key: 'total_amount',
      render: formatCLP,
      align: 'right',
      width: 120
    }
  ];

  return (
    <div className="p-4 max-w-7xl mx-auto">
      <h2 className="text-xl font-semibold mb-4">Historial de Consultas</h2>

      {/* Filters */}
      <div className="flex flex-col sm:flex-row gap-3 mb-4">
        <RangePicker
          value={dateRange}
          onChange={handleDateChange}
          format="DD/MM/YYYY"
          placeholder={['Desde', 'Hasta']}
          allowClear
          className="w-full sm:w-auto"
        />
        <Input.Search
          placeholder="Buscar por nombre"
          onSearch={handleSearch}
          allowClear
          className="w-full sm:w-64"
        />
      </div>

      {/* Table */}
      <Table
        columns={columns}
        dataSource={consultations}
        rowKey="id"
        loading={loading}
        pagination={{
          ...pagination,
          showSizeChanger: true,
          showTotal: (total) => `${total} consultas`
        }}
        onChange={handleTableChange}
        onRow={(record) => ({
          onClick: () => setSelectedConsultation(record),
          className: 'cursor-pointer hover:bg-gray-50'
        })}
        locale={{
          emptyText: <Empty description="No hay consultas en este período" />
        }}
        scroll={{ x: 600 }}
      />

      {/* Detail Modal */}
      <ConsultationDetailModal
        open={!!selectedConsultation}
        consultation={selectedConsultation}
        onClose={() => setSelectedConsultation(null)}
      />
    </div>
  );
}
```

Create `apps/admin/src/components/ConsultationDetailModal.jsx`:

```jsx
import { Modal, Table, Descriptions } from 'antd';
import dayjs from 'dayjs';

// Format price as CLP
const formatCLP = (value) => {
  const num = Number(value);
  return num.toLocaleString('es-CL', { style: 'currency', currency: 'CLP', minimumFractionDigits: 0 });
};

export default function ConsultationDetailModal({ open, consultation, onClose }) {
  if (!consultation) return null;

  const columns = [
    {
      title: 'Producto',
      dataIndex: 'product_name',
      key: 'product_name'
    },
    {
      title: 'Cantidad',
      dataIndex: 'quantity',
      key: 'quantity',
      align: 'center',
      width: 100
    },
    {
      title: 'Precio Unit.',
      dataIndex: 'unit_price',
      key: 'unit_price',
      render: formatCLP,
      align: 'right',
      width: 120
    },
    {
      title: 'Subtotal',
      dataIndex: 'subtotal',
      key: 'subtotal',
      render: formatCLP,
      align: 'right',
      width: 120
    }
  ];

  return (
    <Modal
      title="Detalle de Consulta"
      open={open}
      onCancel={onClose}
      footer={null}
      width={700}
    >
      <Descriptions column={{ xs: 1, sm: 2 }} className="mb-4">
        <Descriptions.Item label="Cliente">
          {consultation.customer_name}
        </Descriptions.Item>
        <Descriptions.Item label="Celular">
          {consultation.customer_phone}
        </Descriptions.Item>
        <Descriptions.Item label="Fecha">
          {dayjs(consultation.created_at).format('DD/MM/YYYY HH:mm')}
        </Descriptions.Item>
        <Descriptions.Item label="Total">
          <strong>{formatCLP(consultation.total_amount)}</strong>
        </Descriptions.Item>
      </Descriptions>

      <h4 className="font-medium mb-2">Productos ({consultation.items?.length || 0})</h4>
      <Table
        columns={columns}
        dataSource={consultation.items || []}
        rowKey="id"
        pagination={false}
        size="small"
        scroll={{ x: 400 }}
      />
    </Modal>
  );
}
```
  </action>
  <verify>
1. Start admin dev server
2. Login and navigate to Historial
3. See table with consultations from last 30 days
4. Change date filter, verify results update
5. Search by name, verify results filter
6. Click row, verify modal shows product details
  </verify>
  <done>
- ConsultationsPage shows paginated list with date/search filters
- Default filter is last 30 days
- Click row opens ConsultationDetailModal with products
- All formatting (dates, currency, phone) works correctly
  </done>
</task>

<task type="auto">
  <name>Task 3: Add Historial tab to admin navigation</name>
  <files>apps/admin/src/main.jsx</files>
  <action>
Update `apps/admin/src/main.jsx` to add Historial tab:

1. Add import at top:
```javascript
import ConsultationsPage from "./pages/ConsultationsPage";
```

2. Add navigation button after "Categorías" button (around line 97):
```jsx
<button
  onClick={() => setCurrentPage('consultations')}
  className={`py-3 px-2 text-sm font-medium border-b-2 -mb-px whitespace-nowrap ${
    currentPage === 'consultations' 
      ? 'border-[#262011] text-[#262011]' 
      : 'border-transparent text-[#262011]/60 hover:text-[#262011]'
  }`}
>
  Historial
</button>
```

3. Add page render in the main content area (alongside other page conditionals):
```jsx
{currentPage === 'consultations' && <ConsultationsPage />}
```
  </action>
  <verify>
1. Login to admin panel
2. See "Historial" tab in navigation
3. Click tab, ConsultationsPage loads
4. Tab shows active state when selected
  </verify>
  <done>
- "Historial" tab appears in admin navigation
- Tab correctly shows active/inactive state
- Click navigates to ConsultationsPage
  </done>
</task>

</tasks>

<verification>
1. Admin can navigate to Historial tab
2. Consultations list shows with default 30-day filter
3. Date range filter works (can select custom range)
4. Search by name filters results
5. Pagination works correctly
6. Click on row opens detail modal
7. Detail modal shows customer info + products table
8. All amounts display in CLP format
</verification>

<success_criteria>
- Admin sees list of consultations with fecha, nombre, celular, productos, total
- Default view shows últimos 30 días
- Admin can filter by date range and search by name
- Admin can view full detail of any consultation in modal
- Products in detail show snapshot data (name, price at time of consultation)
</success_criteria>

<output>
After completion, create `.planning/phases/07-historial-consultas/07-02-SUMMARY.md`
</output>
